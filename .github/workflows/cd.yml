name: CD Pipeline

on:
  push:
    branches:
      - dev
  # workflow_run:  
  #   workflows: ["CI-Pipeline"]
  #   types:
  #     - completed

env:
  AWS_REGION: us-east-1

jobs:
  deploy:
    name: Deploy via Bastion to Private EC2s
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Download Terraform Outputs
        uses: actions/download-artifact@v4
        with:
          name: terraform-output
          path: terraform_outputs

      - name: Parse Private IPs
        id: parse_ips
        run: |
          IPS=$(jq -r '.asg_instance_private_ips.value[]' terraform_outputs/terraform_outputs.json)
          echo "PRIVATE_IPS=$IPS" >> $GITHUB_ENV

      - name: Set up SSH Key for Bastion
        run: |
          echo "${{ secrets.BLOGKEY_PEM }}" > bastion_key.pem
          chmod 600 bastion_key.pem

      - name: SSH to Bastion and Deploy
        run: |
          for ip in $PRIVATE_IPS; do
            echo "Deploying to $ip via Bastion..."

            ssh -o StrictHostKeyChecking=no -i bastion_key.pem ec2-user@${{ secrets.BASTION_PUBLIC_IP }} "
              ssh -o StrictHostKeyChecking=no ec2-user@$ip '
                sudo yum install -y git docker &&
                sudo systemctl start docker &&
                sudo usermod -aG docker ec2-user &&
                cd /home/ec2-user &&
                rm -rf IT-Visionary-Devsecops-Project &&
                git clone https://github.com/visionary-team2025/IT-Visionary-Devsecops-Project.git &&
                cd IT-Visionary-Devsecops-Project &&
                docker compose pull &&
                docker compose up -d
              '
            "
          done

      - name: Slack Notification on Success
        if: success()
        uses: slackapi/slack-github-action@v1.24.0
        with:
          payload: |
            {
              "text": "✅ *CD Pipeline Success*: Deployment to EC2 instances via Bastion was successful!"
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Slack Notification on Failure
        if: failure()
        uses: slackapi/slack-github-action@v1.24.0
        with:
          payload: |
            {
              "text": "❌ *CD Pipeline Failed*: Deployment to EC2 instances via Bastion failed. Check logs for details."
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
