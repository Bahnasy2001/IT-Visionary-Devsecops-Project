name: "IAC pipeline"

on:
  push:
    branches:
      - dev
    
  pull_request:
    branches:
      - main
    paths:
      - terraform/**
  workflow_dispatch: # Manual trigger for apply stepon:
    inputs:
      env:
        description: 'Select environment'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - prod
      action:
        description: 'Select action: apply or destroy'
        required: true
        default: 'apply'
        type: choice
        options:
          - apply
          - destroy    




env:
  AWS_REGION: us-east-1
  AWS_ACCESS_KEY_ID: ${{ secrets.ACCESS_KEY }}
  AWS_SECRET_ACCESS_KEY: ${{ secrets.SECRET_ACCESS_KEY }}
  BUCKET_TF_STATE: ${{ secrets.BUCKET_TF_STATE }}
  

jobs:
  terraform:
    name: "Terraform Pipeline"
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
        working-directory: ./terraform

    steps:
      - name: Checkout source code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
      - name: Set ENV_NAME variable
        run: echo "ENV_NAME=${{ github.event.inputs.env || github.ref_name }}" >> $GITHUB_ENV

      - name: Terraform Init
        run: terraform init -backend-config="bucket=${BUCKET_TF_STATE}"

      - name: Select or Create Workspace
        run: |
          ENV_NAME="${{ github.event.inputs.env || github.ref_name }}"
          echo "Using workspace: $ENV_NAME"
          terraform workspace select "$ENV_NAME" || terraform workspace new "$ENV_NAME"


      - name: Terraform Fmt
        run: terraform fmt 

      - name: Terraform Validate
        run: terraform validate

      - name: Terraform Plan
        id: plan
        run: terraform plan --input=false --out=tfplan -var-file=${ENV_NAME}.tfvars
        continue-on-error: true
        
      - name: Fail if plan failed
        if: steps.plan.outcome == 'failure'
        run: exit 1
        
      - name: Convert plan to JSON
        run: terraform show -json tfplan > tfplan.json
        
      - name: List files
        run: ls -lah
        
      - name: Show tfplan.json content
        run: head -n 20 tfplan.json
        
      - name: Validate JSON format
        run: |
          echo "Validating tfplan.json format..."
          if jq empty tfplan.json 2>/dev/null; then
            echo "‚úÖ Valid JSON format"
          else
            echo "‚ùå Invalid JSON format"
            echo "File content (first 50 lines):"
            head -50 tfplan.json
            exit 1
          fi
  
      - name: Install Checkov
        run: |
          pip install --upgrade pip
          pip install checkov
          
      - name: Verify Checkov installation
        run: |
          checkov --version
          echo "Checkov installed successfully"
          
      - name: Run Checkov Scan
        id: checkov
        run: |
          echo "Starting Checkov scan..."
          echo "Current directory: $(pwd)"
          echo "Available files:"
          ls -la *.json *.tf* 2>/dev/null || echo "No relevant files found"
          
          # Run Checkov with the correct framework flag
          if checkov -f tfplan.json \
            --framework terraform_plan \
            --output json \
            --soft-fail-on HIGH,CRITICAL > checkov-report.json 2>&1; then
            echo "‚úÖ Checkov scan completed successfully"
            CHECKOV_EXIT_CODE=0
          else
            CHECKOV_EXIT_CODE=$?
            echo "‚ö†Ô∏è Checkov scan completed with exit code: $CHECKOV_EXIT_CODE"
          fi
          
          # Verify report was generated
          if [ -f checkov-report.json ] && [ -s checkov-report.json ]; then
            echo "üìä Checkov report generated ($(wc -l < checkov-report.json) lines)"
            
            # Show summary if possible
            if command -v jq &> /dev/null && jq empty checkov-report.json 2>/dev/null; then
              echo "üìã Scan Summary:"
              jq -r '
                if .summary then
                  "Passed: " + (.summary.passed // 0 | tostring) + 
                  ", Failed: " + (.summary.failed // 0 | tostring) + 
                  ", Skipped: " + (.summary.skipped // 0 | tostring)
                else
                  "Summary not available"
                end
              ' checkov-report.json
            fi
          else
            echo "‚ùå Checkov report not generated or empty"
            echo "Attempting alternative approach..."
            
            # Try alternative command syntax
            checkov -f tfplan.json \
              --framework terraform_plan \
              --output json \
              --output-file-path checkov-report.json \
              --soft-fail-on HIGH,CRITICAL || true
              
            if [ -f checkov-report.json ] && [ -s checkov-report.json ]; then
              echo "‚úÖ Alternative command worked"
            else
              echo "‚ùå Alternative command also failed"
              echo "Debug information:"
              echo "Checkov help for terraform_plan:"
              checkov --help | grep -A 5 -B 5 terraform_plan || echo "No terraform_plan help found"
            fi
          fi
          
          # Set output for next steps
          echo "CHECKOV_EXIT_CODE=$CHECKOV_EXIT_CODE" >> $GITHUB_OUTPUT
        continue-on-error: true
        
      - name: Display Checkov Results
        if: always()
        run: |
          echo "=== Checkov Scan Results ==="
          
          if [ -f checkov-report.json ]; then
            if [ -s checkov-report.json ]; then
              echo "üìä Report file exists and has content"
              
              # Try to parse and display summary
              if command -v jq &> /dev/null; then
                echo "Attempting to parse JSON report..."
                if jq empty checkov-report.json 2>/dev/null; then
                  echo "‚úÖ Valid JSON report"
                  
                  # Extract summary
                  echo "=== Summary ==="
                  jq -r '
                    if .summary then
                      "‚úÖ Passed: " + (.summary.passed // 0 | tostring) + "\n" +
                      "‚ùå Failed: " + (.summary.failed // 0 | tostring) + "\n" +
                      "‚è≠Ô∏è Skipped: " + (.summary.skipped // 0 | tostring)
                    else
                      "No summary section found"
                    end
                  ' checkov-report.json
                  
                  # Show high/critical issues
                  echo -e "\n=== High/Critical Issues ==="
                  jq -r '
                    if .results.failed_checks then
                      [.results.failed_checks[] | select(.severity == "HIGH" or .severity == "CRITICAL")] |
                      if length > 0 then
                        "üö® Found " + (length | tostring) + " high/critical issues:" + "\n" +
                        (.[0:5] | map("- " + .check_id + ": " + .check_name + " (" + (.severity // "UNKNOWN") + ")") | join("\n"))
                      else
                        "‚úÖ No high/critical issues found"
                      end
                    else
                      "No failed checks section found"
                    end
                  ' checkov-report.json
                else
                  echo "‚ùå Invalid JSON in report file"
                  echo "First 100 characters of report:"
                  head -c 100 checkov-report.json
                fi
              else
                echo "jq not available, showing raw content (first 20 lines):"
                head -20 checkov-report.json
              fi
            else
              echo "‚ùå Report file exists but is empty"
            fi
          else
            echo "‚ùå No checkov-report.json file found"
            echo "Available files:"
            ls -la
          fi
          
      - name: Upload Checkov Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: checkov-security-report-${{ env.ENV_NAME }}
          path: |
            checkov-report.json
            tfplan.json
          retention-days: 30
          
      - name: Check for Security Issues
        if: always() && steps.checkov.outputs.CHECKOV_EXIT_CODE != '0'
        run: |
          echo "‚ö†Ô∏è Checkov found security issues or encountered errors"
          echo "Please review the uploaded artifacts for detailed information"
          
          # Optionally fail the workflow on high/critical issues
          if [ -f checkov-report.json ] && command -v jq &> /dev/null; then
            CRITICAL_HIGH_COUNT=$(jq -r '
              if .results.failed_checks then
                [.results.failed_checks[] | select(.severity == "HIGH" or .severity == "CRITICAL")] | length
              else
                0
              end
            ' checkov-report.json 2>/dev/null || echo "0")
            
            if [ "$CRITICAL_HIGH_COUNT" -gt 0 ]; then
              echo "üö® Found $CRITICAL_HIGH_COUNT high/critical security issues"
              echo "::warning::$CRITICAL_HIGH_COUNT high/critical security issues found"
              # Uncomment the next line to fail the workflow on high/critical issues
              # exit 1
            fi
          fi

      - name: Upload Checkov Report
        uses: actions/upload-artifact@v4
        with:
          name: checkov-report
          path: checkov-report.json

      - name: Fail if Checkov failed
        if: steps.checkov.outcome == 'failure'
        run: exit 1

      # Apply ONLY when triggered manually
      - name: Terraform Apply or Destroy
        if: github.event_name == 'workflow_dispatch'
        run: |
          if [ "${{ github.event.inputs.action }}" == "destroy" ]; then
            terraform destroy -var-file=${{ github.event.inputs.env }}.tfvars -auto-approve
          else
            terraform apply -var-file=${{ github.event.inputs.env }}.tfvars -auto-approve -input=false -parallelism=10 tfplan
          fi

      - name: Fail if apply/destroy failed
        if: github.event_name == 'workflow_dispatch' && failure()
        run: exit 1

      - name: Terraform Output
        if: github.event_name == 'workflow_dispatch' && success()
        run: terraform output -json > output.json
